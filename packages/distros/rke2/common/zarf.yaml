kind: ZarfInitConfig
metadata:
  name: "distro-rke2"
  architecture: amd64  # arm64 not yet supported by RKE2.  Remove when it is.

components:
  - name: rke2
    only:
      localOS: linux
    description: >
      *** REQUIRES ROOT ***
      RKE2, also known as RKE Government, is Rancher's next-generation Kubernetes distribution.
      It is a fully conformant Kubernetes distribution that focuses on security and compliance within the U.S. Federal Government sector.
      To meet these goals, RKE2 does the following:
      Provides defaults and configuration options that allow clusters to pass the CIS Kubernetes Benchmark v1.6 with minimal operator intervention
      Enables FIPS 140-2 compliance
      Regularly scans components for CVEs using trivy in our build pipeline
    scripts:
      retry: true
      before:
        # If running RHEL variant, disable firewalld
        # https://docs.rke2.io/known_issues/#firewalld-conflicts-with-default-networking
        # NOTE: The empty echo prevents infinite retry loops on non-RHEL systems where the exit code would be an error
        - "[ -e /etc/redhat-release ] && systemctl disable firewalld --now || echo ''"
      after:
        # Configure RKE2 systemd service
        - "[ -e /etc/redhat-release ] && mv /tmp/rke2-canal.conf /etc/NetworkManager/conf.d/ || echo ''"
        - "systemctl daemon-reload"
        - "systemctl enable --now rke2"
    files:
      # NetworkManager script for RHEL Based systems
      # https://docs.rke2.io/known_issues/#networkmanager
      - source: rke2-canal.conf
        target: /tmp/rke2-canal.conf
        executable: false
      # rke2 removal script
      - source: zarf-clean-rke2.sh
        target: /opt/zarf/zarf-clean-rke2.sh
        executable: true
      # The rke2 systemd service definition
      - source: rke2.service
        target: /etc/systemd/system/rke2.service
        symlinks:
          - /etc/systemd/system/multi-user.target.wants/rke2.service
