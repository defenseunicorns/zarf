kind: ZarfInitConfig
metadata:
  name: "distro-rke2"
  architecture: amd64  # arm64 not yet supported by RKE2.  Remove when it is.
components:
  - name: rke2
    only:
      localOS: linux
    description: >
      *** REQUIRES ROOT ***
      RKE2, also known as RKE Government, is Rancher's next-generation Kubernetes distribution.
      It is a fully conformant Kubernetes distribution that focuses on security and compliance within the U.S. Federal Government sector.
      To meet these goals, RKE2 does the following:
      Provides defaults and configuration options that allow clusters to pass the CIS Kubernetes Benchmark v1.6 with minimal operator intervention
      Enables FIPS 140-2 compliance
      Regularly scans components for CVEs using trivy in our build pipeline
    scripts:
      retry: true
      before:
        # If running RHEL variant, disable firewalld and configure NetworkManager
        # https://docs.rke2.io/known_issues/
        # NOTE: The empty echo prevents infinite retry loops on non-RHEL systems where the exit code would be an error
        - "[ -e /etc/redhat-release ] && systemctl disable firewalld --now || echo ''"
        - "[ -e /etc/redhat-release ] && mkdir -p /etc/NetworkManager/conf.d/ || echo ''"
        - "[ -e /etc/redhat-release ] && mv /tmp/rke2-canal.conf /etc/NetworkManager/conf.d/ || echo ''"
      after:
        - export INSTALL_RKE2_ARTIFACT_PATH=/tmp
        - /tmp/rke2-install.sh
        - systemctl daemon-reload
        - systemctl enable rke2-server.service
        - systemctl start rke2-server.service
        - export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
        - chmod 644 $KUBECONFIG
    files:
      # Canal CNI Configuration to work properly with NetworkManager
      - source: rke2-canal.conf
        target: /tmp/rke2-canal.conf
        executable: false
      # RKE2 Install file generated from the RKE2 Website.
      - source: rke2-install.sh
        target: /tmp/rke2-install.sh
        executable: true
      # RKE2 Core Images
      - source: https://github.com/rancher/rke2/releases/download/v1.22.15%2Brke2r2/rke2-images-core.linux-amd64.tar.zst
        target: /tmp/rke2-images-core.linux-amd64.tar.zst
        executable: false
      # RKE2 Image for Canal CNI Support
      - source: https://github.com/rancher/rke2/releases/download/v1.22.15%2Brke2r2/rke2-images-canal.linux-amd64.tar.zst
        target: /tmp/rke2-images-canal.linux-amd64.tar.zst
        executable: false
      # RKE2 Binary
      - source: https://github.com/rancher/rke2/releases/download/v1.22.15%2Brke2r2/rke2.linux-amd64.tar.gz
        target: /tmp/rke2.linux-amd64.tar.gz
        executable: false
      # SHA 256 for binary checks done by the install script.
      - source: https://github.com/rancher/rke2/releases/download/v1.22.15%2Brke2r2/sha256sum-amd64.txt
        target: /tmp/sha256sum-amd64.txt
  # Placeholder for the ARM 64 Version when it's supported
  - name: rke2
    description: >
      ****** READ THIS ARM 64 NOT SUPPORTED *********
      rke2 is not currently supported on arm64 architecture, due to upstream dependencies. This functionality will be
      added when rke2 supports arm64 architecture.

      If you would like to buid the amd64 version of this package on a arm64 based machine use the -a flag.

      ex: `zarf package create . -a amd64`
    only:
      cluster:
        architecture: arm64
        components:
          files:
            - common/empty-file
            scripts:
              retry: false
              after:
                # Force the return of a non-zero exit code.
                - |
                'echo "rke2 is not currently supported on arm64 architecture, due to upstream dependencies. This functionality will be
                added when rke2 supports arm64 architecture.'
                - 'exit(1)'