kind: ZarfInitConfig
metadata:
  name: distro-k3s
  description: Used to establish a new Zarf cluster

components:
  # AMD-64 version of the K3s stack
  - name: k3s
    import:
      path: common
      name: k3s
    only:
      cluster:
        architecture: amd64
    files:
      # Include the actual K3s binary
      - source: https://github.com/k3s-io/k3s/releases/download/v1.28.6+k3s1/k3s
        shasum: 8d1372fad6680d858608981df945e13b6781d57fb5cdb8d686bee3785080f567
        target: /usr/sbin/k3s
        executable: true
        # K3s magic provides these tools when symlinking
        symlinks:
          - /usr/sbin/kubectl
          - /usr/sbin/ctr
          - /usr/sbin/crictl
      # Transfer the K3s images for containerd to pick them up
      - source: https://github.com/k3s-io/k3s/releases/download/v1.28.6+k3s1/k3s-airgap-images-amd64.tar.zst
        shasum: 4900544b64f7dc9d971cd215757476de0cdfe8a75c881d3e4222f89eb4db0d82
        target: /var/lib/rancher/k3s/agent/images/k3s.tar.zst
    actions:
      onDeploy:
        before:
          - cmd: if [ "$(uname -m)" != "x86_64" ]; then echo "this package architecture is amd64, but the target system has a different architecture. These architectures must be the same" && exit 1; fi
            description: Check that the host architecture matches the package architecture
            maxRetries: 0

  # ARM-64 version of the K3s stack
  - name: k3s
    import:
      path: common
      name: k3s
    only:
      cluster:
        architecture: arm64
    files:
      # Include the actual K3s binary
      - source: https://github.com/k3s-io/k3s/releases/download/v1.28.6+k3s1/k3s-arm64
        shasum: ed16458ea7e746eea6a91608848c6ada006d14138f0ee16db91f86fd4a3ea4f3
        target: /usr/sbin/k3s
        executable: true
        # K3s magic provides these tools when symlinking
        symlinks:
          - /usr/sbin/kubectl
          - /usr/sbin/ctr
          - /usr/sbin/crictl
      # Transfer the K3s images for containerd to pick them up
      - source: https://github.com/k3s-io/k3s/releases/download/v1.28.6+k3s1/k3s-airgap-images-arm64.tar.zst
        shasum: 62ed669a6d00a4edef96e785bd29f5da027c67b618512983604670db2a4dcc70
        target: /var/lib/rancher/k3s/agent/images/k3s.tar.zst
    actions:
      onDeploy:
        before:
          - cmd: if [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "arm64" ]; then echo "this package architecture is arm64, but the target system has a different architecture. These architectures must be the same" && exit 1; fi
            description: Check that the host architecture matches the package architecture
            maxRetries: 0
